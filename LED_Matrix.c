/*************************************************************************
 *************************************************************************
							LED MATRIX MAZE GAME 
 * Authors: Thao Tran
			Dana Alkattan
			William Boyd
			Andrew Vo
 *************************************************************************
 ************************************************************************/

#define	  F_CPU			16000000 

#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>

#define BIT_IS_CLEAR(byte, bit) (!(byte & (1 << bit)))

/*************************************************************************
						Greeting & 10 Mazes
*************************************************************************/
uint16_t HELLO[8] = {0b1000000011111111,
					 0b0100000010110101,
					 0b0010000010110101,
					 0b0001000010000101,
					 0b0000100010110101,
					 0b0000010010110101,
					 0b0000001011111111,
					 0b0000000111111111};

uint16_t THREE[8] = {0b1000000011111111,
					 0b0100000011000011,
					 0b0010000011111011,
					 0b0001000011000011,
					 0b0000100011111011,
					 0b0000010011000011,
					 0b0000001011111111,
					 0b0000000111111111};

uint16_t TWO[8]	  = {0b1000000011111111,
					 0b0100000011000011,
					 0b0010000011111011,
					 0b0001000011000011,
					 0b0000100011011111,
					 0b0000010011000011,
					 0b0000001011111111,
					 0b0000000111111111};

uint16_t ONE[8]	  = {0b1000000011111111,
					 0b0100000011110111,
				   	 0b0010000011100111,
					 0b0001000011110111,
					 0b0000100011110111,
					 0b0000010011110111,
					 0b0000001011111111,
					 0b0000000111111111};
 
uint16_t CLEAR[8] = {0b1000000011111111,
					 0b0100000011111111,
					 0b0010000011111111,
					 0b0001000011111111,
					 0b0000100011111111,
					 0b0000010011111111,
					 0b0000001011111111,
					 0b0000000111111111};
					 
uint16_t MAZE1[8] = {0b1000000000011000,
					 0b0100000001111110,
					 0b0010000001110110,
					 0b0001000011110111,
					 0b0000100011100111,
					 0b0000010001101110,
					 0b0000001001111110,
					 0b0000000100011000};

uint16_t MAZE2[8] = {0b1000000000000000,
					 0b0100000001111110,
					 0b0010000011011000,
					 0b0001000000001010,
					 0b0000100001111010,
					 0b0000010000100010,
					 0b0000001001111110,
					 0b0000000100000010};

uint16_t MAZE3[8] = {0b1000000000100101,
					 0b0100000010110101,
					 0b0010000010010111,
					 0b0001000011110101,
					 0b0000100011010001,
					 0b0000010010011111,
					 0b0000001010110001,
					 0b0000000110110111};

uint16_t MAZE4[8] = {0b1000000010011001,
					 0b0100000011100110,
					 0b0010000001111110,
					 0b0001000010111110,
					 0b0000100010011001,
					 0b0000010011000011,
					 0b0000001011100111,
					 0b0000000111111111};


uint16_t MAZE5[8] = {0b1000000011101111,
					 0b0100000011110111,
					 0b0010000000111011,
					 0b0001000001111101,
					 0b0000100001111011,
					 0b0000010010110111,
					 0b0000001010101111,
					 0b0000000111111111};

uint16_t MAZE6[8] = {0b1000000001100111,
					 0b0100000011111101,
					 0b0010000011011011,
					 0b0001000011100111,
					 0b0000100011110111,
					 0b0000010011011011,
					 0b0000001010111101,
					 0b0000000101111110};


uint16_t MAZE7[8] = {0b1000000001111111,
					 0b0100000010110001,
					 0b0010000011110111,
					 0b0001000011110111,
					 0b0000100011000111,
					 0b0000010011011111,
					 0b0000001011011101,
					 0b0000000111111110};


uint16_t MAZE8[8] = {0b1000000000000111,
					 0b0100000001111111,
					 0b0010000011111111,
					 0b0001000011101111,
					 0b0000100011101111,
					 0b0000010011101110,
					 0b0000001011111110,
					 0b0000000100011111};

uint16_t MAZE9[8] = {0b1000000000111100,
					 0b0100000001111110,
					 0b0010000011011011,
					 0b0001000011111111,
					 0b0000100011011011,
				     0b0000010011100111,
					 0b0000001001111110,
					 0b0000000100111100};


uint16_t MAZE10[8] = {0b1000000011111111,
					  0b0100000011000101,
					  0b0010000011100101,
					  0b0001000000111100,
					  0b0000100010011001,
					  0b0000010011001111,
					  0b0000001011100011,
					  0b0000000100000000};

 
/*************************************************************************
						Configure Connections
*************************************************************************/
#define		HC595_DDR		DDRD		
#define		HC595_PORT		PORTD
#define		HC595_IN		PD0		//Data input to the first register
#define		HC595_CLOCK		PD1		//Clock signal
#define		HC595_LATCH		PD2		//Latch signal
#define		HC595_CLEAR		PD4		//Clear Signal

/*************************************************************************
						HC595 Initialization
*************************************************************************/
void HC595_Init(void)
{
	//Set PORTD0-2 to be outputs
	HC595_DDR |= (1<<HC595_IN) | (1<<HC595_CLOCK) | (1<<HC595_LATCH) | (1<<HC595_CLEAR);
}

/*************************************************************************
						HC595 Clock Pulse
*************************************************************************/
void HC595_Pulse(void)
{
	HC595_PORT |= (1<<HC595_CLOCK);
	HC595_PORT &= ~(1<<HC595_CLOCK);
}

/*************************************************************************
							HC595 Latch
*************************************************************************/
void HC595_Latch(void)
{
	HC595_PORT |= (1<<HC595_LATCH);
	_delay_ms(1);
	HC595_PORT &= ~(1<<HC595_LATCH);
}

/*************************************************************************
						HC595 Send Serial Inputs
*************************************************************************/
void HC595_Shift(uint16_t data)
{
	for (uint8_t i = 0; i < 16; i++)
	{
		if (data & 0b1000000000000000)
			HC595_PORT |= (1<<HC595_IN);	//Data input = 1
		else 
			HC595_PORT &= ~(1<<HC595_IN);	//Data input = 0
		
		HC595_Pulse();	//Pulse the clock
		
		data = data << 1; 
	}
	
	HC595_Latch();		//Latch data to outputs
}

/*************************************************************************
							HC595 Reset
*************************************************************************/
void HC595_Reset(void)
{
	HC595_PORT &= ~(1<<HC595_CLEAR);
	HC595_Pulse();
	HC595_Latch();
	HC595_PORT |= (1<<HC595_CLEAR);	
}

/*************************************************************************
						Button Interrupt Init
*************************************************************************/
void Button_Init(void)
{
	DDRD &= ~(1 << PORTD3);		//Set PD3 for input
	PORTD |= (1 << PORTD3);		// set PD2/INT0 (pin 4) internal pull-up resistor*/

	PCICR |= (1 << PCIE2);      //Set pin-change interrupt for D pins
	PCMSK2 |= (1 << PCINT19);   //Mask PCINT19
	sei();                      //Set global interrupt enable bit
}

/*************************************************************************
							LED Matrix
*************************************************************************/
void LED_Matrix(uint16_t data[])
{
	for (int i = 0; i < 100; i++)
	{		
		for(uint8_t i = 0; i < 8; i++)
		{
			HC595_Shift(data[i]);		
			//_delay_ms(1000);
		}
	}
}

/*************************************************************************
							ISR Service
*************************************************************************/
ISR(PCINT2_vect)
{   
	// Get a random number (0 to 255)
	long randNumber = random();
	randNumber = randNumber % 11;
					 								
	if (BIT_IS_CLEAR(PIND, PD3))
	{	
		LED_Matrix(HELLO);
		LED_Matrix(THREE);
		LED_Matrix(TWO);
		LED_Matrix(ONE);
	
		for (int i = 0; i < 5; i++)
		{
			switch (randNumber)
			{
				case(1):
					LED_Matrix(MAZE1);
					break;
				case(2):
					LED_Matrix(MAZE2);
					break;
				case(3):
					LED_Matrix(MAZE3);
					break;
				case(4):
					LED_Matrix(MAZE4);
					break;
				case(5):
					LED_Matrix(MAZE5);
					break;
				case(6):
					LED_Matrix(MAZE6);
					break;
				case(7):
					LED_Matrix(MAZE7);
					break;
				case(8):
					LED_Matrix(MAZE8);
					break;
				case(9):
					LED_Matrix(MAZE9);
					break;
				case(10):
					LED_Matrix(MAZE10);
					break;
			}	
		}
	}
	
	LED_Matrix(CLEAR);
}

int main(void)
{
	/*********** Test Code ************
	HC595_DDR |= (1<<HC595_IN);
	
	while (1)
	{
		HC595_PORT |= (1<<HC595_IN);
		_delay_ms(3000);
		HC595_PORT &= ~(1<<HC595_IN);
		_delay_ms(3000);
	}
	***********************************/
							
	Button_Init();
	HC595_Init();	
	
	while(1)
	{
		//_delay_ms(1);
	}
}

